{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block content %}
<h1>Checkout</h1>

<h2>Detalles del Pedido</h2>
<table>
    <thead>
        <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Subtotal</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr>
            <td>{{ item.name }}</td>
            <td>{{ item.quantity }}</td>
            <td>${{ item.price }}</td>
            <td>${{ item.quantity * item.price }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<p>Total: $<span id="total">{{ total }}</span></p>
<p id="credit_fee" style="display: none;">Recargo por tarjeta de crédito (15%): $<span id="credit_fee_amount"></span></p>
<p id="grand_total">Total con recargo: $<span id="grand_total_amount">{{ total }}</span></p>
<p id="iva_amount" style="display: none;">IVA (21%): $<span id="iva_value"></span></p>
<p id="final_total" style="display: none;">Total Final: $<span id="final_total_amount">{{ total }}</span></p>

<h2>Opciones de Pago</h2>
<form action="{{ url_for('process_payment', order_number=order_number) }}" method="post">
    <input type="hidden" name="order_number" value="{{ order_number }}">
    <input type="hidden" name="iva_value" id="hidden_iva_value">
    <input type="hidden" name="final_total" id="hidden_final_total">
    <input type="hidden" name="iva_condition" id="hidden_iva_condition">

    <label for="payment_method">Elija su metodo de Pago:</label>
    <select id="payment_method" name="payment_method">
        <option value="cash">Efectivo</option>
        <option value="credit">Tarjeta de Crédito</option>
        <option value="debit">Tarjeta de Débito</option>
        <option value="account">Cuenta Corriente</option>
    </select>
    <div id="credit_options" style="display: none;">
        <label for="installments">Elija la cantidad de cuotas:</label>
        <select id="installments" name="installments">
            <option value="1">1 cuota</option>
            <option value="6">6 cuotas</option>
            <option value="12">12 cuotas</option>
        </select>
    </div>
    <div id="debit_options" style="display: none;">
        <p>Tarjeta de Débito: Pago automático en una sola cuota.</p>
    </div>
    <label for="taxes">Condicion ante el IVA:</label>
    <select id="taxes" name="IVA">
        <option value="Responsable no Inscripto">IVA Responsable no Inscripto</option>
        <option value="Responsable Inscripto">IVA Responsable Inscripto</option>
    </select>
    <button type="submit">Confirmar Pago</button>
</form>


<script>
document.getElementById('payment_method').addEventListener('change', function() {
    updateTotals();
});

document.getElementById('taxes').addEventListener('change', function() {
    updateTotals();
});

function updateTotals() {
    var total = parseFloat(document.getElementById('total').innerText);
    var creditFee = document.getElementById('credit_fee');
    var creditFeeAmount = document.getElementById('credit_fee_amount');
    var grandTotal = document.getElementById('grand_total');
    var grandTotalAmount = document.getElementById('grand_total_amount');
    var ivaAmount = document.getElementById('iva_amount');
    var ivaValue = document.getElementById('iva_value');
    var finalTotal = document.getElementById('final_total');
    var finalTotalAmount = document.getElementById('final_total_amount');
    var hiddenIvaValue = document.getElementById('hidden_iva_value');
    var hiddenFinalTotal = document.getElementById('hidden_final_total');
    var hiddenIvaCondition = document.getElementById('hidden_iva_condition');
    var creditOptions = document.getElementById('credit_options');
    var debitOptions = document.getElementById('debit_options');
    var paymentMethod = document.getElementById('payment_method').value;
    var taxes = document.getElementById('taxes').value;

    var fee = 0;
    if (paymentMethod == 'credit') {
        creditOptions.style.display = 'block';
        debitOptions.style.display = 'none';
        fee = total * 0.15;
        creditFeeAmount.innerText = fee.toFixed(2);
        creditFee.style.display = 'block';
    } else if (paymentMethod == 'debit') {
        creditOptions.style.display = 'none';
        debitOptions.style.display = 'block';
        creditFee.style.display = 'none';
    } else {
        creditOptions.style.display = 'none';
        debitOptions.style.display = 'none';
        creditFee.style.display = 'none';
    }

    grandTotalAmount.innerText = (total + fee).toFixed(2);
    grandTotal.style.display = 'block';

    var iva = 0;
    if (taxes == 'Responsable Inscripto') {
        iva = (total + fee) * 0.21;
        ivaValue.innerText = iva.toFixed(2);
        ivaAmount.style.display = 'block';
    } else {
        ivaAmount.style.display = 'none';
    }

    finalTotalAmount.innerText = (total + fee + iva).toFixed(2);
    finalTotal.style.display = 'block';

    hiddenIvaValue.value = iva.toFixed(2);
    hiddenFinalTotal.value = (total + fee + iva).toFixed(2);
    hiddenIvaCondition.value = taxes;  
}

document.addEventListener('DOMContentLoaded', function() {
    updateTotals();
});
</script>
{% endblock %}
